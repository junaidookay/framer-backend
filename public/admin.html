<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Donation Admin</title>
    <style>
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
        background: #0b0b0b;
        color: #f5f5f5;
        margin: 0;
        padding: 24px;
      }
      .wrap {
        max-width: 720px;
        margin: 0 auto;
        background: #141414;
        border: 1px solid #2a2a2a;
        border-radius: 14px;
        padding: 20px;
      }
      h1 {
        margin: 0 0 12px 0;
        font-size: 22px;
        letter-spacing: 0.3px;
      }
      p {
        margin: 0 0 16px 0;
        color: #cfcfcf;
        line-height: 1.4;
      }
      label {
        display: block;
        margin: 14px 0 6px;
        font-size: 13px;
        color: #d9d9d9;
      }
      input {
        width: 100%;
        box-sizing: border-box;
        padding: 12px 12px;
        border-radius: 10px;
        border: 1px solid #2f2f2f;
        background: #0f0f0f;
        color: #f5f5f5;
        outline: none;
      }
      input:focus {
        border-color: #6b6b6b;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .buttons {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        flex-wrap: wrap;
      }
      button {
        padding: 12px 14px;
        border-radius: 10px;
        border: 0;
        cursor: pointer;
        font-weight: 650;
      }
      .primary {
        background: #f2b705;
        color: #111;
      }
      .secondary {
        background: #2a2a2a;
        color: #f5f5f5;
        border: 1px solid #3a3a3a;
      }
      .danger {
        background: #b00020;
        color: #fff;
      }
      .note {
        margin-top: 14px;
        padding: 12px;
        border-radius: 10px;
        background: #101010;
        border: 1px solid #2a2a2a;
        color: #cfcfcf;
        font-size: 13px;
      }
      .log {
        margin-top: 16px;
        padding: 12px;
        border-radius: 10px;
        background: #0f0f0f;
        border: 1px solid #2a2a2a;
        min-height: 90px;
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        color: #d7d7d7;
      }
      .small {
        font-size: 12px;
        color: #bdbdbd;
        margin-top: 6px;
      }
      @media (max-width: 640px) {
        .row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Donation Admin</h1>
      <p>
        Enter the campaign ID and the combined views (YouTube + Instagram), then save.
        When you're ready, run charges.
      </p>

      <label for="apiBase">API Base URL</label>
      <input id="apiBase" placeholder="Leave blank to use this domain" />

      <div class="row">
        <div>
          <label for="campaignId">Campaign ID</label>
          <input id="campaignId" placeholder="uuid (from Supabase campaigns table)" />
          <div class="small">Tip: paste the campaigns.id value here.</div>
        </div>
        <div>
          <label for="password">Admin Password</label>
          <input id="password" type="password" placeholder="ADMIN_PASSWORD" />
        </div>
      </div>

      <label for="finalViews">Final Combined Views</label>
      <input id="finalViews" type="number" min="0" step="1" placeholder="e.g. 18734" />

      <div class="buttons">
        <button class="secondary" id="btnSaveViews">Save Views (Lock Campaign)</button>
        <button class="primary" id="btnRunCharges">Run Charges Now</button>
        <button class="danger" id="btnClear">Clear Log</button>
      </div>

      <div class="note">
        Run Charges attempts to charge all supporters who completed the pledge setup
        and havenâ€™t been charged yet. If a bank requires extra verification, the pledge
        will be marked requires_action in Supabase.
      </div>

      <div class="log" id="log"></div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      function log(msg) {
        const el = $("log");
        const now = new Date().toLocaleString();
        el.textContent += `[${now}] ${msg}\n`;
        el.scrollTop = el.scrollHeight;
      }

      function getBase() {
        const base = $("apiBase").value.trim();
        return base ? base.replace(/\/+$/, "") : window.location.origin;
      }

      async function post(path, body) {
        const url = `${getBase()}${path}`;
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        let data = null;
        try {
          data = await res.json();
        } catch {}

        if (!res.ok) {
          const err = data?.error || `Request failed (${res.status})`;
          throw new Error(err);
        }

        return data;
      }

      $("btnSaveViews").addEventListener("click", async () => {
        const campaign_id = $("campaignId").value.trim();
        const password = $("password").value;
        const final_views = Number($("finalViews").value);

        if (!campaign_id) return alert("Campaign ID is required");
        if (!password) return alert("Password is required");
        if (!Number.isFinite(final_views) || final_views < 0)
          return alert("Final views must be 0 or more");

        try {
          log(`Saving views: ${final_views} for campaign ${campaign_id}...`);
          const data = await post("/api/admin/set-views", {
            password,
            campaign_id,
            final_views: Math.floor(final_views),
          });
          log(`Saved views: ${JSON.stringify(data)}`);
        } catch (e) {
          log(`Save views error: ${e.message}`);
          alert(e.message);
        }
      });

      $("btnRunCharges").addEventListener("click", async () => {
        const campaign_id = $("campaignId").value.trim();
        const password = $("password").value;

        if (!campaign_id) return alert("Campaign ID is required");
        if (!password) return alert("Password is required");

        const confirmText =
          "This will attempt to charge all eligible pledges now.\n\nClick OK to continue, or Cancel to stop.";
        if (!confirm(confirmText)) return;

        try {
          log(`Running charges for campaign ${campaign_id}...`);
          const data = await post("/api/admin/run-charges", { password, campaign_id });
          log(`Run charges result: ${JSON.stringify(data, null, 2)}`);
          alert(
            `Done.\nCharged: ${data.charged}\nSkipped: ${data.skipped}\nFailed: ${data.failed}\nRequires action: ${data.requiresAction}`
          );
        } catch (e) {
          log(`Run charges error: ${e.message}`);
          alert(e.message);
        }
      });

      $("btnClear").addEventListener("click", () => {
        $("log").textContent = "";
      });

      log("Admin loaded.");
    </script>
  </body>
</html>

